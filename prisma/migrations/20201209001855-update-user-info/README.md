# Migration `20201209001855-update-user-info`

This migration has been generated by Phat Tran at 12/9/2020, 7:18:56 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "public"."UserVerifyDocumentType" AS ENUM ('Facebook', 'Email', 'PhoneNumber')

CREATE TYPE "public"."RentingItemRequestActivityType" AS ENUM ('Comment', 'Declined', 'Approved', 'InProgress', 'Completed', 'Cancelled')

Begin;
CREATE TYPE "public"."ItemStatus_new" AS ENUM ('Draft', 'Blocked', 'Published');
ALTER TABLE "public"."Item" ALTER COLUMN "status" TYPE "ItemStatus_new" USING ("status"::text::"ItemStatus_new");
ALTER TYPE "ItemStatus" RENAME TO "ItemStatus_old";
ALTER TYPE "ItemStatus_new" RENAME TO "ItemStatus";
DROP TYPE "ItemStatus_old";
Commit

ALTER TABLE "public"."RentingItemRequestComment" DROP CONSTRAINT "RentingItemRequestComment_itemId_fkey"

ALTER TABLE "public"."WishingItemList" DROP CONSTRAINT "WishingItemList_itemId_fkey"

ALTER TABLE "public"."ItemReview" ADD COLUMN "images" text   ,
ALTER COLUMN "reviewComment" DROP NOT NULL

ALTER TABLE "public"."User" DROP COLUMN "name",
DROP COLUMN "bio",
DROP COLUMN "avatarImage",
DROP COLUMN "coverImage",
ADD COLUMN "facebookId" text   ,
ADD COLUMN "facebookAccessToken" text   ,
ADD COLUMN "googleId" text   ,
ADD COLUMN "googleAccessToken" text   ,
ALTER COLUMN "email" DROP NOT NULL

CREATE TABLE "public"."UserInfo" (
"id" text   NOT NULL ,
"displayName" text   ,
"bio" text   ,
"avatarImage" text   ,
"coverImage" text   ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."UserIdentifyDocument" (
"id" text   NOT NULL ,
"userId" text   NOT NULL ,
"type" "UserVerifyDocumentType"  NOT NULL ,
"value" text   NOT NULL ,
"isVerfied" boolean   ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."UserReview" (
"id" text   NOT NULL ,
"toUserId" text   NOT NULL ,
"rentingRequestId" text   NOT NULL ,
"reviewScore" integer   NOT NULL ,
"reviewComment" text   ,
"ownerUserId" text   NOT NULL ,
"isDeleted" boolean   DEFAULT false,
"createdDate" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedDate" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedBy" text   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."RentingItemRequestActivity" (
"id" text   NOT NULL ,
"itemId" text   NOT NULL ,
"data" text   ,
"type" "RentingItemRequestActivityType"  NOT NULL ,
"files" text   ,
"isLocked" boolean   DEFAULT false,
"lockedBy" text   NOT NULL ,
"isDisabled" boolean   DEFAULT false,
"isDeleted" boolean   DEFAULT false,
"createdDate" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedDate" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"createdBy" text   NOT NULL ,
"updatedBy" text   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."WishingItem" (
"id" text   NOT NULL ,
"ownerUserId" text   NOT NULL ,
"itemId" text   NOT NULL ,
"createdDate" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."MyUserContactItem" (
"id" text   NOT NULL ,
"ownerUserId" text   NOT NULL ,
"userId" text   NOT NULL ,
"createdDate" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
PRIMARY KEY ("id")
)

DROP TABLE "public"."LenderReview"

DROP TABLE "public"."MyUserContactList"

DROP TABLE "public"."RentingItemRequestComment"

DROP TABLE "public"."WishingItemList"

CREATE INDEX "wishing_item_main_index" ON "public"."WishingItem"("ownerUserId")

CREATE INDEX "my_user_contact_main_index" ON "public"."MyUserContactItem"("ownerUserId")

CREATE UNIQUE INDEX "User.facebookId_unique" ON "public"."User"("facebookId")

CREATE UNIQUE INDEX "User.googleId_unique" ON "public"."User"("googleId")

ALTER TABLE "public"."RentingItemRequestActivity" ADD FOREIGN KEY("itemId")REFERENCES "public"."Item"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."WishingItem" ADD FOREIGN KEY("itemId")REFERENCES "public"."Item"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."MyUserContactItem" ADD FOREIGN KEY("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20201207084528-add-index-in-wishing-item-and-my-contact..20201209001855-update-user-info
--- datamodel.dml
+++ datamodel.dml
@@ -2,9 +2,9 @@
 // learn more about it in the docs: https://pris.ly/d/prisma-schema
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider = "prisma-client-js"
@@ -16,18 +16,40 @@
 }
 model User {
   id            String      @id @default(uuid())
-  email         String      @unique
+  email         String?      @unique
   passwordHash  String
-  name          String?
+  currentHashedRefreshToken String? @unique
+  role          UserRole[]
+  facebookId    String?      @unique
+  facebookAccessToken String?
+  googleId      String?     @unique
+  googleAccessToken String?
+}
+
+model UserInfo {
+  id            String      @id
+  displayName          String?
   bio           String?
   avatarImage   String? // { id, url }
   coverImage    String? // { id, url }
-  currentHashedRefreshToken String? @unique
-  role          UserRole[]
 }
+enum UserVerifyDocumentType {
+  Facebook
+  Email
+  PhoneNumber
+}
+
+model UserIdentifyDocument {
+  id            String      @id @default(uuid())
+  userId        String
+  type          UserVerifyDocumentType
+  value         String
+  isVerfied     Boolean?
+}
+
 model Area {
   id            String      @id @default(uuid())
   region        String
   name          String
@@ -166,42 +188,54 @@
   id                      String          @id @default(uuid())
   rentingItem           Item @relation(fields: [itemId], references: [id])
   itemId                String
   reviewScore           Int
-  reviewComment         String
+  reviewComment         String?
+  images                  String?
   ownerUserId             String
   isDeleted               Boolean?        @default(false)
   createdDate             DateTime        @default(now())
   updatedDate             DateTime        @default(now())
   updatedBy               String
 }
-model LenderReview {
+model UserReview {
   id                      String          @id @default(uuid())
-  lenderId              String
+  toUserId              String
+  rentingRequestId      String
   reviewScore           Int
-  reviewComment         String
+  reviewComment         String?
   ownerUserId             String
   isDeleted               Boolean?        @default(false)
   createdDate             DateTime        @default(now())
   updatedDate             DateTime        @default(now())
   updatedBy               String
 }
-model RentingItemRequestComment {
+enum RentingItemRequestActivityType {
+  Comment
+  Declined
+  Approved
+  InProgress
+  Completed
+  Cancelled
+}
+
+model RentingItemRequestActivity {
   id                      String          @id @default(uuid())
   rentingItem           Item @relation(fields: [itemId], references: [id])
   itemId                String
-  content             String?
+  data             String?
+  type              RentingItemRequestActivityType
   files                 String? // JSON
   isLocked              Boolean?        @default(false)
   lockedBy               String
   isDisabled              Boolean?        @default(false)
   isDeleted               Boolean?        @default(false)
   createdDate             DateTime        @default(now())
   updatedDate             DateTime        @default(now())
+  createdBy               String
   updatedBy               String
-  isSystem              Boolean?        @default(false)
 }
 // Log Systems
 model SearchKeywork {
```


